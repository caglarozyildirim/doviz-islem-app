<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√∂viz ƒ∞≈ülem Formu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-wrapper {
            max-width: 1800px;
            margin: 0 auto;
        }

        .two-column-container {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 0;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 12px 12px 0 0;
        }

        .form-panel {
            padding: 30px;
            background: white;
            border-right: 2px solid #e2e8f0;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            border-radius: 12px 0 0 0;
        }

        .history-panel {
            padding: 20px;
            background: #f8fafc;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            border-radius: 0 12px 0 0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .history-header h2 {
            font-size: 16px;
            color: #1e293b;
            font-weight: 700;
        }

        .transaction-count {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .history-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transaction-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.2s;
        }

        .transaction-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .transaction-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .transaction-card-row:last-child {
            margin-bottom: 0;
        }

        .transaction-label {
            color: #64748b;
            font-weight: 600;
        }

        .transaction-value {
            color: #1e293b;
            font-weight: 600;
        }

        .transaction-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
        }

        .transaction-type-badge.alis {
            background: #d1fae5;
            color: #047857;
        }

        .transaction-type-badge.satis {
            background: #fee2e2;
            color: #b91c1c;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .empty-state-subtext {
            font-size: 11px;
        }

        .bottom-stats {
            background: white;
            padding: 15px 30px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-value.primary {
            color: #667eea;
        }

        .stat-value.success {
            color: #10b981;
        }

        .stat-value.danger {
            color: #ef4444;
        }

        .header-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .field-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-label {
            background: #d0d0d0;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 13px;
            white-space: nowrap;
            min-width: 150px;
        }

        .field-value {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .field-value:focus {
            outline: none;
            border-color: #667eea;
        }

        .field-value.readonly {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
        }

        .status-badge.aktif {
            background: #d1fae5;
            color: #047857;
        }

        .status-badge.pasif {
            background: #fee2e2;
            color: #b91c1c;
        }

        .autocomplete-container {
            position: relative;
            flex: 1;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .autocomplete-item:hover {
            background: #f8fafc;
        }

        .section-title {
            background: #333;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            font-size: 14px;
        }

        .table-container {
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f0f0f0;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #ccc;
        }

        td {
            padding: 8px;
            border: 1px solid #ccc;
        }

        td input, td select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            font-size: 13px;
        }

        td input:focus, td select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-add {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #059669;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-remove:hover {
            background: #dc2626;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .total-summary {
            background: #f9fafb;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-row:last-child {
            margin-bottom: 0;
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            padding-top: 8px;
            border-top: 2px solid #e0e0e0;
        }

        .calculated-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }

        .calculated-display .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .calculated-display .amount {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Two Column Layout -->
        <div class="two-column-container">
            <!-- Left Panel: Form -->
            <div class="form-panel">
                <!-- Header Section -->
                <div class="header-row">
                    <div class="field-group">
                        <div class="field-label">M√º≈üteri Temsilcisi</div>
                        <input type="text" class="field-value readonly" id="temsilci" value="√úmit AKY√úZ" readonly>
                    </div>
                    <div class="field-group">
                        <div class="field-label">ƒ∞≈ülem Tarihi</div>
                        <input type="date" class="field-value" id="islemTarihi">
                    </div>
                </div>

                <div class="header-row">
                    <div class="field-group">
                        <div class="field-label">UNVAN</div>
                        <div class="autocomplete-container">
                            <input type="text" class="field-value" id="unvan" placeholder="M√º≈üteri aratƒ±n..." autocomplete="off" oninput="filterCustomers()" onfocus="showCustomerList()">
                            <div class="autocomplete-list" id="customerList"></div>
                        </div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">M√ú≈ûTERƒ∞ DURUM</div>
                        <div class="field-value readonly" id="musteriDurum" style="background: #f0f0f0; display: flex; align-items: center;">
                            <span id="durumBadge">M√º≈üteri se√ßiniz</span>
                        </div>
                    </div>
                </div>

                <div class="field-group" style="margin-bottom: 20px;">
                    <div class="field-label">VERGƒ∞ MUAFƒ∞YET</div>
                    <input type="text" class="field-value readonly" id="vergiMuafiyet" value="Hayƒ±r" readonly>
                </div>

                <!-- Transaction Section -->
                <div class="section-title">ƒ∞≈ûLEM Bƒ∞LGƒ∞LERƒ∞</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 140px;">ƒ∞≈ülem T√ºr√º</th>
                                <th style="width: 140px;">Para Birimi</th>
                                <th style="width: 120px;">Miktar</th>
                                <th style="width: 80px;">BSMV</th>
                                <th style="width: 100px;">Fiyat (Kur)</th>
                                <th style="width: 100px;">Vergi</th>
                                <th style="width: 150px;">Tutar</th>
                                <th style="width: 80px;">Birim</th>
                                <th style="width: 120px;">Val√∂r Tarihi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select id="islemTuru" onchange="selectCurrency()">
                                        <option value="">Se√ßiniz</option>
                                        <option value="ALI≈û">ALI≈û</option>
                                        <option value="SATI≈û">SATI≈û</option>
                                    </select>
                                </td>
                                <td>
                                    <select id="kodu" onchange="selectCurrency()">
                                        <option value="">Se√ßiniz</option>
                                        <option value="TL">TL - T√ºrk Lirasƒ±</option>
                                        <option value="USD">USD - Amerikan Dolarƒ±</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - ƒ∞ngiliz Sterlini</option>
                                        <option value="CHF">CHF - ƒ∞svi√ßre Frangƒ±</option>
                                        <option value="JPY">JPY - Japon Yeni</option>
                                        <option value="CAD">CAD - Kanada Dolarƒ±</option>
                                        <option value="AUD">AUD - Avustralya Dolarƒ±</option>
                                        <option value="SAR">SAR - Suudi Arabistan Riyali</option>
                                        <option value="SEK">SEK - ƒ∞sve√ß Kronu</option>
                                        <option value="NOK">NOK - Norve√ß Kronu</option>
                                        <option value="DKK">DKK - Danimarka Kronu</option>
                                        <option value="RUB">RUB - Rus Rublesi</option>
                                        <option value="CNY">CNY - √áin Yuanƒ±</option>
                                        <option value="KWD">KWD - Kuveyt Dinarƒ±</option>
                                        <option value="AED">AED - BAE Dirhemi</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" id="miktar" step="0.01" placeholder="0.00" oninput="updateCalculation()">
                                </td>
                                <td>
                                    <input type="text" id="bsmv" readonly style="background: #f0f0f0; text-align: center;" value="YOK">
                                </td>
                                <td>
                                    <input type="number" id="fiyat" step="0.0001" placeholder="0.0000" oninput="updateCalculation()">
                                </td>
                                <td>
                                    <input type="number" id="vergi" readonly step="0.01" placeholder="0.00" value="0.00" style="background: #f0f0f0;">
                                </td>
                                <td>
                                    <input type="text" id="tutar" readonly style="background: #f0f0f0; font-weight: bold;">
                                </td>
                                <td>
                                    <input type="text" id="birim" value="TL">
                                </td>
                                <td>
                                    <input type="date" id="valorTarihi">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Calculated Total Display -->
                <div class="calculated-display">
                    <div class="label">TOPLAM TUTAR</div>
                    <div class="amount" id="toplamTutar">0,00 TL</div>
                </div>

                <!-- Payment Banks Section -->
                <div class="section-title">√ñDEME BANKALARI (√áoklu Hesap)</div>
                <div class="table-container">
                    <table id="paymentBanksTable">
                        <thead>
                            <tr>
                                <th style="width: 350px;">√ñdeme Banka - IBAN</th>
                                <th style="width: 100px;">Kodu</th>
                                <th style="width: 150px;">Miktar</th>
                                <th style="width: 80px;">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="paymentBanksBody">
                            <tr>
                                <td>
                                    <select class="payment-bank" onchange="updatePaymentCurrency(this)">
                                        <option value="">Banka Se√ßiniz...</option>
                                        <option value="Denizbank - TR33 0012 3456 7890 1234 5678 90">Denizbank - TR33 0012 3456 7890 1234 5678 90</option>
                                        <option value="ƒ∞≈übankasƒ± - TR44 0006 4000 0011 2345 6789 01">ƒ∞≈übankasƒ± - TR44 0006 4000 0011 2345 6789 01</option>
                                        <option value="Garanti BBVA - TR55 0006 2000 0550 0006 2958 47">Garanti BBVA - TR55 0006 2000 0550 0006 2958 47</option>
                                        <option value="Yapƒ± Kredi - TR76 0006 7010 0000 0012 3456 78">Yapƒ± Kredi - TR76 0006 7010 0000 0012 3456 78</option>
                                        <option value="Akbank - TR98 0004 6006 0888 8000 1234 56">Akbank - TR98 0004 6006 0888 8000 1234 56</option>
                                        <option value="QNB Finansbank - TR12 0011 1000 0000 0123 4567 89">QNB Finansbank - TR12 0011 1000 0000 0123 4567 89</option>
                                        <option value="Ziraat Bankasƒ± - TR44 0001 0001 7845 6789 3050 01">Ziraat Bankasƒ± - TR44 0001 0001 7845 6789 3050 01</option>
                                        <option value="Halkbank - TR66 0001 2009 4520 0016 0000 01">Halkbank - TR66 0001 2009 4520 0016 0000 01</option>
                                        <option value="Vakƒ±fbank - TR88 0001 5001 5800 7289 1234 56">Vakƒ±fbank - TR88 0001 5001 5800 7289 1234 56</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="payment-currency">
                                        <option value="TL">TL</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                        <option value="CHF">CHF</option>
                                        <option value="JPY">JPY</option>
                                        <option value="CAD">CAD</option>
                                        <option value="AUD">AUD</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="payment-amount" step="0.01" placeholder="0.00" oninput="calculatePaymentTotal()">
                                </td>
                                <td style="text-align: center;">
                                    <button type="button" class="btn-remove" onclick="removePaymentRow(this)">Sil</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn-add" onclick="addPaymentRow()">+ √ñdeme Hesabƒ± Ekle</button>
                </div>

                <!-- Payment Summary -->
                <div class="total-summary">
                    <div class="total-row">
                        <span>ƒ∞≈ülem Tutarƒ±:</span>
                        <span id="islemTutari">0,00 TL</span>
                    </div>
                    <div class="total-row">
                        <span>√ñdeme Toplamƒ±:</span>
                        <span id="odemeToplami">0,00 TL</span>
                    </div>
                    <div class="total-row">
                        <span>KALAN:</span>
                        <span id="kalanTutar">0,00 TL</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">Temizle</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransaction()">Kaydet</button>
                </div>
            </div>

            <!-- Right Panel: Transaction History -->
            <div class="history-panel">
                <div class="history-header">
                    <h2>ƒ∞≈ülem Ge√ßmi≈üi <span class="transaction-count" id="transactionCount">0</span></h2>
                </div>

                <div class="history-filters">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; width: 100%;">
                        <span style="font-size: 11px; font-weight: 600; color: #64748b;">Durum Filtresi:</span>
                        <button class="filter-btn active" data-filter-type="durum" onclick="filterByDurum('T√ºm√º')">T√ºm√º</button>
                        <button class="filter-btn" data-filter-type="durum" onclick="filterByDurum('√ñdeme Hazƒ±r')">√ñdeme Hazƒ±r</button>
                        <button class="filter-btn" data-filter-type="durum" onclick="filterByDurum('√ñdeme Bekliyor')">√ñdeme Bekliyor</button>
                        <button class="filter-btn" data-filter-type="durum" onclick="filterByDurum('E≈üle≈ümeyen')">E≈üle≈ümeyen</button>
                        <button class="filter-btn" data-filter-type="durum" onclick="filterByDurum('Onay Bekliyor')">Onay Bekliyor</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                        <button class="filter-btn active" data-filter-type="islem" onclick="filterTransactions('T√ºm√º')">T√ºm√º</button>
                        <button class="filter-btn" data-filter-type="islem" onclick="filterTransactions('ALI≈û')">Alƒ±≈ü</button>
                        <button class="filter-btn" data-filter-type="islem" onclick="filterTransactions('SATI≈û')">Satƒ±≈ü</button>
                    </div>
                </div>

                <div class="transaction-list" id="transactionList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Hen√ºz i≈ülem yok</div>
                        <div class="empty-state-subtext">Sol panelden i≈ülem ekleyebilirsiniz</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Stats -->
        <div class="bottom-stats">
            <div class="stat-item">
                <div class="stat-label">Toplam ƒ∞≈ülem</div>
                <div class="stat-value" id="statToplam">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">D√∂viz Alƒ±≈ü</div>
                <div class="stat-value success" id="statAlis">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">D√∂viz Satƒ±≈ü</div>
                <div class="stat-value danger" id="statSatis">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Toplam Tutar</div>
                <div class="stat-value primary" id="statTutar">0 ‚Ç∫</div>
            </div>
        </div>
    </div>

    <script>
        // Customer database
        const customers = [
            { name: 'Mehmet G√ñR', status: 'Aktif', bsmv: 'YOK', vergiMuafiyet: 'YOK' },
            { name: 'Serkan Y√ºksel', status: 'Aktif', bsmv: 'VAR', vergiMuafiyet: 'VAR' },
            { name: 'Ahmet Demir', status: 'Pasif', bsmv: 'VAR', vergiMuafiyet: 'YOK' },
            { name: 'Ali Yƒ±lmaz', status: 'Aktif', bsmv: 'YOK', vergiMuafiyet: 'VAR' },
            { name: 'Ay≈üe ≈ûahin', status: 'Aktif', bsmv: 'VAR', vergiMuafiyet: 'YOK' },
            { name: 'Fatma √áelik', status: 'Aktif', bsmv: 'YOK', vergiMuafiyet: 'YOK' },
            { name: 'Zeynep Arslan', status: 'Pasif', bsmv: 'VAR', vergiMuafiyet: 'VAR' },
            { name: 'Elif √ñzt√ºrk', status: 'Aktif', bsmv: 'YOK', vergiMuafiyet: 'YOK' },
            { name: 'Mustafa Aydƒ±n', status: 'Aktif', bsmv: 'VAR', vergiMuafiyet: 'VAR' },
            { name: 'H√ºseyin Ko√ß', status: 'Aktif', bsmv: 'YOK', vergiMuafiyet: 'YOK' }
        ];

        let selectedCustomer = null;
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let currentFilter = 'T√ºm√º';
        let currentDurumFilter = 'T√ºm√º';

        // Initialize dates
        document.getElementById('islemTarihi').valueAsDate = new Date();
        document.getElementById('valorTarihi').valueAsDate = new Date();

        // Load transactions on page load
        window.addEventListener('load', function() {
            renderTransactions();
            updateStats();
        });

        // Customer autocomplete functions
        function showCustomerList() {
            filterCustomers();
        }

        function filterCustomers() {
            const searchValue = document.getElementById('unvan').value.toLowerCase();
            const customerList = document.getElementById('customerList');

            const filtered = customers.filter(c =>
                c.name.toLowerCase().includes(searchValue)
            );

            if (filtered.length === 0) {
                customerList.classList.remove('active');
                return;
            }

            customerList.innerHTML = filtered.map(customer => `
                <div class="autocomplete-item" onclick="selectCustomer('${customer.name}')">
                    ${customer.name}
                </div>
            `).join('');

            customerList.classList.add('active');
        }

        function selectCustomer(name) {
            const customer = customers.find(c => c.name === name);
            if (!customer) return;

            selectedCustomer = customer;
            document.getElementById('unvan').value = customer.name;

            const durumBadge = document.getElementById('durumBadge');
            durumBadge.className = 'status-badge ' + customer.status.toLowerCase();
            durumBadge.textContent = customer.status;

            document.getElementById('vergiMuafiyet').value = customer.vergiMuafiyet === 'VAR' ? 'Evet' : 'Hayƒ±r';

            if (customer.vergiMuafiyet === 'VAR') {
                document.getElementById('bsmv').value = 'YOK';
            } else {
                document.getElementById('bsmv').value = 'VAR';
            }

            document.getElementById('customerList').classList.remove('active');
            updateCalculation();
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.getElementById('customerList').classList.remove('active');
            }
        });

        // Currency selection - AUTO FILL LAST RATE
        function selectCurrency() {
            const currency = document.getElementById('kodu').value;
            const islemTuru = document.getElementById('islemTuru').value;

            if (!currency || currency === 'TL') {
                updateCalculation();
                return;
            }

            // If transaction type is not selected yet, don't auto-fill
            if (!islemTuru) {
                updateCalculation();
                return;
            }

            // Find last transaction with this currency AND transaction type
            const lastTransaction = transactions
                .filter(t => t.islem.kodu === currency && t.islem.tur === islemTuru)
                .sort((a, b) => b.id - a.id)[0];

            if (lastTransaction && lastTransaction.islem.fiyat) {
                // Auto-fill the last rate
                document.getElementById('fiyat').value = lastTransaction.islem.fiyat.toFixed(4);
                console.log(`‚úÖ Son ${currency} ${islemTuru} kuru otomatik getirildi: ${lastTransaction.islem.fiyat.toFixed(4)}`);
            } else {
                console.log(`‚ÑπÔ∏è ${currency} i√ßin ${islemTuru} i≈ülemi bulunamadƒ±.`);
            }

            updateCalculation();
        }

        // Update calculation
        function updateCalculation() {
            const kodu = document.getElementById('kodu').value;
            const miktar = parseFloat(document.getElementById('miktar').value) || 0;
            const fiyat = parseFloat(document.getElementById('fiyat').value) || 0;
            const bsmv = document.getElementById('bsmv').value;

            if (!kodu || miktar === 0 || fiyat === 0) {
                document.getElementById('vergi').value = '0.00';
                document.getElementById('tutar').value = '';
                document.getElementById('toplamTutar').textContent = '0,00 TL';
                document.getElementById('islemTutari').textContent = '0,00 TL';
                calculatePaymentTotal();
                return;
            }

            const baseAmount = miktar * fiyat;
            let vergi = 0;
            if (bsmv === 'VAR') {
                vergi = baseAmount * 0.002;
            }

            const tutar = baseAmount + vergi;

            document.getElementById('vergi').value = vergi.toFixed(2);
            const tutarFormatted = tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('tutar').value = tutarFormatted + ' TL';
            document.getElementById('toplamTutar').textContent = tutarFormatted + ' TL';
            document.getElementById('islemTutari').textContent = tutarFormatted + ' TL';

            calculatePaymentTotal();
        }

        // Add payment row
        function addPaymentRow() {
            const kalanStr = document.getElementById('kalanTutar').textContent.replace(/[^\d,]/g, '').replace(',', '.');
            const kalan = parseFloat(kalanStr) || 0;

            if (kalan <= 0) {
                alert('Kalan tutar yok! Yeni √∂deme kalemi eklenemez.');
                return;
            }

            const tbody = document.getElementById('paymentBanksBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select class="payment-bank" onchange="updatePaymentCurrency(this)">
                        <option value="">Banka Se√ßiniz...</option>
                        <option value="Denizbank - TR33 0012 3456 7890 1234 5678 90">Denizbank - TR33 0012 3456 7890 1234 5678 90</option>
                        <option value="ƒ∞≈übankasƒ± - TR44 0006 4000 0011 2345 6789 01">ƒ∞≈übankasƒ± - TR44 0006 4000 0011 2345 6789 01</option>
                        <option value="Garanti BBVA - TR55 0006 2000 0550 0006 2958 47">Garanti BBVA - TR55 0006 2000 0550 0006 2958 47</option>
                        <option value="Yapƒ± Kredi - TR76 0006 7010 0000 0012 3456 78">Yapƒ± Kredi - TR76 0006 7010 0000 0012 3456 78</option>
                        <option value="Akbank - TR98 0004 6006 0888 8000 1234 56">Akbank - TR98 0004 6006 0888 8000 1234 56</option>
                        <option value="QNB Finansbank - TR12 0011 1000 0000 0123 4567 89">QNB Finansbank - TR12 0011 1000 0000 0123 4567 89</option>
                        <option value="Ziraat Bankasƒ± - TR44 0001 0001 7845 6789 3050 01">Ziraat Bankasƒ± - TR44 0001 0001 7845 6789 3050 01</option>
                        <option value="Halkbank - TR66 0001 2009 4520 0016 0000 01">Halkbank - TR66 0001 2009 4520 0016 0000 01</option>
                        <option value="Vakƒ±fbank - TR88 0001 5001 5800 7289 1234 56">Vakƒ±fbank - TR88 0001 5001 5800 7289 1234 56</option>
                    </select>
                </td>
                <td>
                    <select class="payment-currency">
                        <option value="TL">TL</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="CHF">CHF</option>
                        <option value="JPY">JPY</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="payment-amount" step="0.01" placeholder="0.00" max="${kalan.toFixed(2)}" oninput="limitPaymentAmount(this); calculatePaymentTotal()">
                </td>
                <td style="text-align: center;">
                    <button type="button" class="btn-remove" onclick="removePaymentRow(this)">Sil</button>
                </td>
            `;
            tbody.appendChild(newRow);
        }

        function limitPaymentAmount(input) {
            const kalanStr = document.getElementById('kalanTutar').textContent.replace(/[^\d,]/g, '').replace(',', '.');
            const kalan = parseFloat(kalanStr) || 0;

            let otherPaymentsTotal = 0;
            document.querySelectorAll('.payment-amount').forEach(other => {
                if (other !== input) {
                    otherPaymentsTotal += parseFloat(other.value) || 0;
                }
            });

            const islemTutariStr = document.getElementById('islemTutari').textContent.replace(/[^\d,]/g, '').replace(',', '.');
            const islemTutari = parseFloat(islemTutariStr) || 0;
            const maxAllowed = islemTutari - otherPaymentsTotal;

            if (parseFloat(input.value) > maxAllowed) {
                input.value = maxAllowed.toFixed(2);
            }
        }

        function updatePaymentCurrency(selectElement) {
            // Optional feature
        }

        function removePaymentRow(btn) {
            const tbody = document.getElementById('paymentBanksBody');
            if (tbody.children.length > 1) {
                btn.closest('tr').remove();
                calculatePaymentTotal();
            } else {
                alert('En az bir √∂deme hesabƒ± bulunmalƒ±dƒ±r!');
            }
        }

        function calculatePaymentTotal() {
            let total = 0;
            document.querySelectorAll('.payment-amount').forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            const islemTutariStr = document.getElementById('islemTutari').textContent.replace(/[^\d,]/g, '').replace(',', '.');
            const islemTutari = parseFloat(islemTutariStr) || 0;
            const kalan = islemTutari - total;

            // Check if payment total exceeds transaction amount
            if (total > islemTutari && islemTutari > 0) {
                alert('‚ö†Ô∏è UYARI: √ñdeme toplamƒ± i≈ülem tutarƒ±nƒ± a≈üamaz!\n\nƒ∞≈ülem Tutarƒ±: ' + islemTutari.toFixed(2) + ' TL\n√ñdeme Toplamƒ±: ' + total.toFixed(2) + ' TL');
            }

            document.getElementById('odemeToplami').textContent = total.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' TL';
            document.getElementById('kalanTutar').textContent = kalan.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' TL';

            const kalanElement = document.getElementById('kalanTutar');
            if (kalan > 0.01) {
                kalanElement.style.color = '#ef4444';
            } else if (kalan < -0.01) {
                kalanElement.style.color = '#f59e0b';
            } else {
                kalanElement.style.color = '#10b981';
            }
        }

        // Save transaction
        function saveTransaction() {
            const data = {
                id: Date.now(),
                temsilci: document.getElementById('temsilci').value,
                islemTarihi: document.getElementById('islemTarihi').value,
                musteri: selectedCustomer,
                vergiMuafiyet: document.getElementById('vergiMuafiyet').value,
                durum: '√ñdeme Hazƒ±r',
                islem: {
                    tur: document.getElementById('islemTuru').value,
                    kodu: document.getElementById('kodu').value,
                    miktar: parseFloat(document.getElementById('miktar').value) || 0,
                    bsmv: document.getElementById('bsmv').value,
                    fiyat: parseFloat(document.getElementById('fiyat').value) || 0,
                    vergi: parseFloat(document.getElementById('vergi').value) || 0,
                    tutar: document.getElementById('tutar').value,
                    birim: document.getElementById('birim').value,
                    valorTarihi: document.getElementById('valorTarihi').value
                },
                odemeler: [],
                tarih: new Date().toLocaleString('tr-TR')
            };

            const rows = document.querySelectorAll('#paymentBanksBody tr');
            rows.forEach(row => {
                const banka = row.querySelector('.payment-bank').value;
                const kodu = row.querySelector('.payment-currency').value;
                const miktar = row.querySelector('.payment-amount').value;

                if (banka && miktar) {
                    data.odemeler.push({ banka, kodu, miktar: parseFloat(miktar) });
                }
            });

            if (!selectedCustomer) {
                alert('L√ºtfen m√º≈üteri se√ßiniz!');
                return;
            }

            if (!data.islem.tur || !data.islem.kodu || !data.islem.miktar || !data.islem.fiyat) {
                alert('L√ºtfen i≈ülem bilgilerini eksiksiz doldurunuz!');
                return;
            }

            if (data.odemeler.length === 0) {
                alert('L√ºtfen en az bir √∂deme hesabƒ± ekleyiniz!');
                return;
            }

            const kalanStr = document.getElementById('kalanTutar').textContent.replace(/[^\d,-]/g, '').replace(',', '.');
            const kalan = parseFloat(kalanStr) || 0;

            if (Math.abs(kalan) > 0.01) {
                const confirmSave = confirm(`√ñdeme toplamƒ± i≈ülem tutarƒ±yla e≈üle≈ümiyor. Kalan: ${document.getElementById('kalanTutar').textContent}\n\nYine de kaydetmek istiyor musunuz?`);
                if (!confirmSave) return;
            }

            transactions.unshift(data);
            localStorage.setItem('transactions', JSON.stringify(transactions));

            renderTransactions();
            updateStats();

            alert('ƒ∞≈ülem ba≈üarƒ±yla kaydedildi!');
            clearForm();
        }

        function renderTransactions() {
            const listElement = document.getElementById('transactionList');

            let filtered = transactions;

            if (currentFilter !== 'T√ºm√º') {
                filtered = filtered.filter(t => t.islem.tur === currentFilter);
            }

            if (currentDurumFilter !== 'T√ºm√º') {
                filtered = filtered.filter(t => t.durum === currentDurumFilter);
            }

            if (filtered.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Hen√ºz i≈ülem yok</div>
                        <div class="empty-state-subtext">Sol panelden i≈ülem ekleyebilirsiniz</div>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = filtered.map(t => `
                <div class="transaction-card">
                    <div class="transaction-card-row">
                        <span class="transaction-type-badge ${t.islem.tur === 'ALI≈û' ? 'alis' : 'satis'}">
                            ${t.islem.tur}
                        </span>
                        <span class="transaction-label">${t.tarih}</span>
                    </div>
                    <div class="transaction-card-row">
                        <span class="transaction-label">M√º≈üteri</span>
                        <span class="transaction-value">${t.musteri.name}</span>
                    </div>
                    <div class="transaction-card-row">
                        <span class="transaction-label">ƒ∞≈ülem</span>
                        <span class="transaction-value">${t.islem.miktar.toFixed(2)} ${t.islem.kodu}</span>
                    </div>
                    <div class="transaction-card-row">
                        <span class="transaction-label">Kur</span>
                        <span class="transaction-value">${t.islem.fiyat.toFixed(4)}</span>
                    </div>
                    <div class="transaction-card-row">
                        <span class="transaction-label">Tutar</span>
                        <span class="transaction-value" style="color: #667eea; font-weight: 700;">${t.islem.tutar}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('transactionCount').textContent = filtered.length;
        }

        function filterTransactions(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn[data-filter-type="islem"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderTransactions();
        }

        function filterByDurum(durum) {
            currentDurumFilter = durum;
            document.querySelectorAll('.filter-btn[data-filter-type="durum"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderTransactions();
        }

        function updateStats() {
            const alisCount = transactions.filter(t => t.islem.tur === 'ALI≈û').length;
            const satisCount = transactions.filter(t => t.islem.tur === 'SATI≈û').length;

            let totalAmount = 0;
            transactions.forEach(t => {
                const amount = t.islem.miktar * t.islem.fiyat + t.islem.vergi;
                totalAmount += amount;
            });

            document.getElementById('statToplam').textContent = transactions.length;
            document.getElementById('statAlis').textContent = alisCount;
            document.getElementById('statSatis').textContent = satisCount;
            document.getElementById('statTutar').textContent = totalAmount.toFixed(2) + ' ‚Ç∫';
        }

        function clearForm() {
            selectedCustomer = null;
            document.getElementById('unvan').value = '';
            document.getElementById('durumBadge').className = '';
            document.getElementById('durumBadge').textContent = 'M√º≈üteri se√ßiniz';
            document.getElementById('vergiMuafiyet').value = 'Hayƒ±r';
            document.getElementById('islemTuru').value = '';
            document.getElementById('kodu').value = '';
            document.getElementById('miktar').value = '';
            document.getElementById('bsmv').value = 'YOK';
            document.getElementById('fiyat').value = '';
            document.getElementById('vergi').value = '0.00';
            document.getElementById('tutar').value = '';
            document.getElementById('birim').value = 'TL';
            document.getElementById('valorTarihi').valueAsDate = new Date();

            const tbody = document.getElementById('paymentBanksBody');
            tbody.innerHTML = `
                <tr>
                    <td>
                        <select class="payment-bank" onchange="updatePaymentCurrency(this)">
                            <option value="">Banka Se√ßiniz...</option>
                            <option value="Denizbank - TR33 0012 3456 7890 1234 5678 90">Denizbank - TR33 0012 3456 7890 1234 5678 90</option>
                            <option value="ƒ∞≈übankasƒ± - TR44 0006 4000 0011 2345 6789 01">ƒ∞≈übankasƒ± - TR44 0006 4000 0011 2345 6789 01</option>
                            <option value="Garanti BBVA - TR55 0006 2000 0550 0006 2958 47">Garanti BBVA - TR55 0006 2000 0550 0006 2958 47</option>
                            <option value="Yapƒ± Kredi - TR76 0006 7010 0000 0012 3456 78">Yapƒ± Kredi - TR76 0006 7010 0000 0012 3456 78</option>
                            <option value="Akbank - TR98 0004 6006 0888 8000 1234 56">Akbank - TR98 0004 6006 0888 8000 1234 56</option>
                            <option value="QNB Finansbank - TR12 0011 1000 0000 0123 4567 89">QNB Finansbank - TR12 0011 1000 0000 0123 4567 89</option>
                            <option value="Ziraat Bankasƒ± - TR44 0001 0001 7845 6789 3050 01">Ziraat Bankasƒ± - TR44 0001 0001 7845 6789 3050 01</option>
                            <option value="Halkbank - TR66 0001 2009 4520 0016 0000 01">Halkbank - TR66 0001 2009 4520 0016 0000 01</option>
                            <option value="Vakƒ±fbank - TR88 0001 5001 5800 7289 1234 56">Vakƒ±fbank - TR88 0001 5001 5800 7289 1234 56</option>
                        </select>
                    </td>
                    <td>
                        <select class="payment-currency">
                            <option value="TL">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="CHF">CHF</option>
                            <option value="JPY">JPY</option>
                            <option value="CAD">CAD</option>
                            <option value="AUD">AUD</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="payment-amount" step="0.01" placeholder="0.00" oninput="calculatePaymentTotal()">
                    </td>
                    <td style="text-align: center;">
                        <button type="button" class="btn-remove" onclick="removePaymentRow(this)">Sil</button>
                    </td>
                </tr>
            `;

            updateCalculation();
        }
    </script>
</body>
</html>